<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Google Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Gafata&family=Inter:wght@400;500;700&display=swap"
    rel="stylesheet">

  <!-- CSS -->
  <script th:src="@{/js/bootstrap.min.js}"></script>
  <script th:src="@{/js/fontawesome-all.min.js}"></script>
  <link rel="stylesheet" th:href="@{/css/main.css}" />
  <link rel="stylesheet" th:href="@{/css/common.css}" />
  <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}" />
  <link rel="stylesheet" th:href="@{/css/fontawesome-all.min.css}" />
  <title th:text="${music.title} + ' - DoomChit'">곡 정보 - DoomChit</title>

  <style>
    @media screen and (min-width: 640px) {
      #album-main-img {
        width: 295px;
      }
    }

    #album-img {
      width: 100%;
    }

    #music-sub-album-text>h4,
    #music-sub-album-text>h6 {
      line-height: 1.2;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    dd>#text {
      text-overflow: auto;
    }

    dt,
    #stars {
      float: left;
    }

    #music-sum-list>dt,
    #music-production>.list>dt {
      width: 4rem;
    }

    #music-infos>.list>dt {
      width: 7rem;
    }

    #stars,
    #likes-icon {
      color: #a352d2;
    }

    .form-control {
      border: none;
    }

    /*광역*/
    a {
      color: #a352d2;
      text-decoration-line: none;
    }

    .btn-primary {
      background-color: #a352d2;
      border-color: #a352d2;
    }

    .btn-primary:hover {
      background-color: darkred;
      border-color: darkred;
    }
  </style>
</head>

<body>
  <!-- 헤더 -->
  <th:block th:replace="~{fragments/header :: header}"></th:block>

  <div id="contents" class="container-xl" style="padding-top: 40px;">
    <div id="music-info" class="border-top pb-5">

      <div id="music-summary" class="row featurette pb-4">
        <div id="album-main-img" class="featurette-image img-fluid col col-md-3 pb-3">
          <img name="musicsImage" class="w-100" th:src="${music.image}" src="../img/album_sample.jpg" />
        </div>
		<div class="col pt-2 pe-3">
          <h3 name="musicsTitle" class="text-break" th:text="${music.title}"></h3>
          <h4 name="artist" class="text-break pb-2"><a href="#" th:text="${music.artist}"></a></h4>
          <dl id="music-sum-list" class="list">
            <dt>발매일</dt>
            <dd name="relDate" th:text="${music.relDate}"></dd>
            <dt>장르</dt>
            <dd name="genre" th:text="${music.genre}"></dd>
            <dt>길이</dt>
            <dd name="duration"
              th:text="${music.duration / 60} + ':' + ${#numbers.formatInteger(music.duration % 60, 2)}"></dd>
          </dl>
          <div id="ratings">
            <div id="rating" class="fs-4">
				<dl>
				  <dt id="stars" class="me-2 d-flex align-items-center" th:with="rating=${avgRating}">
				    <th:block th:each="num : ${#numbers.sequence(1, 5)}"><i th:if="${num <= rating}" class="fa-solid fa-star"></i><i th:if="${num > rating && (num - 0.5) <= rating}" class="fa-solid fa-star-half-stroke"></i><i th:if="${(num - 0.5) > rating}" class="fa-regular fa-star"></i></th:block>
				    <label id="avgRating" th:text="${avgRating}" class="ms-1">0.0</label>
				  </dt>

				  <dd id="ratingCount" class="pe-2 pt-2 fs-6 text-muted" th:text="|(${#lists.size(reviewList)}명이 참여)|"></dd>
                </dd>
              </dl>
            </div>
          </div>
          <div id="likes">
            <dl>
              <dt>
                <div>
                  <!-- 좋아요 버튼 (토글) -->
                  <a th:href="@{/doomchit/like/toggle/{mno}(mno=${music.mno})}" class="text-decoration-none"
                    sec:authorize="isAuthenticated()">
                    <i id="likes-icon" type="button"
                      th:class="${isLiked} ? 'fa-solid fa-heart fs-3 pe-1' : 'fa-regular fa-heart fs-3 pe-1'"
                      th:style="${isLiked} ? 'color: #a352d2;' : 'color: #000;'"></i>
                  </a>
                  <!-- 비로그인 시 로그인 페이지로 안내 -->
                  <a th:href="@{/login}" class="text-decoration-none" sec:authorize="isAnonymous()"
                    onclick="return confirm('로그인이 필요한 서비스입니다. 로그인 페이지로 이동하시겠습니까?');">
                    <i id="likes-icon" type="button" class="fa-regular fa-heart fs-3 pe-1" style="color: #000;"></i>
                  </a>
                </div>
              </dt>
              <dd name="likesCount" th:text="${#numbers.formatInteger(likeCount, 0, 'COMMA')}">0</dd>
            </dl>
          </div>
        </div>
      </div>

      <div id="music-lyrics" class="pb-4">
        <h2 class="pb-2 border-bottom">가사</h2>
        <div id="lyrics" name="lyrics">
          <div id="lyricsContent" class="lyrics-content collapsed">
            <p th:text="${music.lyrics != null ? music.lyrics : '가사 데이터가 없습니다.'}" style="white-space: pre-wrap;">
              가사 데이터가 없습니다.
            </p>
          </div>
          <button id="lyricsBtn" class="show-more-btn" onclick="toggleLyrics()">펼치기</button>
        </div>
      </div>

      <script>
        function toggleLyrics() {
          const content = document.getElementById('lyricsContent');
          const btn = document.getElementById('lyricsBtn');
          if (content.classList.contains('collapsed')) {
            content.classList.remove('collapsed');
            btn.innerText = "접기";
          } else {
            content.classList.add('collapsed');
            btn.innerText = "펼치기";
          }
        }
      </script>

      <div id="music-production" class="pb-4">
        <h2 class="pb-2 border-bottom">노래 / 작곡 / 작사</h2>
        <dl class="list">
          <dt class="flex-shrink-0 text-nowrap me-3">노래</dt>
          <dd name="artist" class="d-flex text-break" th:text="${music.artist}">가수명</dd>
          <dt class="flex-shrink-0 text-nowrap me-3">작곡</dt>
          <dd name="composer" class="d-flex text-break" th:text="${music.composer}">작곡가</dd>
          <dt class="flex-shrink-0 text-nowrap me-3">작사</dt>
          <dd name="lyricist" class="d-flex text-break" th:text="${music.lyricist}">작사자</dd>
        </dl>
      </div>

      <div id="music-infos" class="pb-5">
        <h2 class="pb-2 border-bottom">상세 정보</h2>
        <dl class="list">
          <dt class="flex-shrink-0 text-nowrap me-3">제목</dt>
          <dd name="musicsTitle" class="d-flex text-break" th:text="${music.title}">곡 제목</dd>
          <dt class="flex-shrink-0 text-nowrap me-3">장르</dt>
          <dd name="genre" class="d-flex text-break" th:text="${music.genre}">블루스</dd>
          <dt class="flex-shrink-0 text-nowrap me-3">길이</dt>
          <dd name="duration" class="d-flex text-break"
            th:text="${music.duration / 60} + ':' + ${#numbers.formatInteger(music.duration % 60, 2)}">0:00</dd>
          <dt class="flex-shrink-0 text-nowrap me-3">발매일</dt>
          <dd name="relDate" class="d-flex text-break" th:text="${music.relDate}">2026.01.07.</dd>
          <dt class="flex-shrink-0 text-nowrap me-3">첫 수록 앨범</dt>
          <dd name="albumTitle" class="d-flex text-break" th:text="${music.albumTitle}">앨범명</dd>
          <dt class="flex-shrink-0 text-nowrap me-3">발매사</dt>
          <dd name="publisher" class="d-flex text-break" th:text="${music.publisher}">발매사</dd>
          <dt class="flex-shrink-0 text-nowrap me-3">기획사</dt>
          <dd name="agency" class="d-flex text-break" th:text="${music.agency}">기획사</dd>
        </dl>
      </div>


      <div id="reviews" class="mb-5">
        <div id="reviews-tab">
          <div class="d-flex justify-content-between pb-2 mb-3 border-bottom">
            <h2>
              리뷰 <span th:text="|${#lists.size(reviewList)}개|">0개</span>
            </h2>
            <div class="fs-6 pt-2">
              <b>최신순</b><label class="px-2">|</label><a href="#reviews">추천순</a>
            </div>
          </div>

        </div>

        <div sec:authorize="isAnonymous()" class="bg-body-secondary rounded mb-4">
          <div class="p-3">
            댓글을 입력하려면 <a th:href="@{/doomchit/login}">로그인</a>을 해야합니다.
          </div>
        </div>

        <div sec:authorize="isAuthenticated()" class="border rounded p-3 mb-4">
          <form id="reviews" th:action="@{/doomchit/{mno}(mno=${music.mno})}" th:object="${reviewForm}" method="post">
            <textarea th:field="*{content}" class="form-control border mb-3" placeholder="리뷰를 등록하려면 평점 주기 및 댓글을 작성하세요."
              required></textarea>
            <div id="rating" class="d-flex justify-content-between">
              <div id="stars" class="me-2 pt-2 fs-3">
                <a href="#reviews"><i class="fa-solid fa-star"></i></a>
                <input id="rating_input" type="range" th:field="*{rating}" min="1" max="5">
                <label id="rating_value"></label>
              </div>
              <button class="btn btn-primary btn-lg" type="submit">
                리뷰 등록하기
              </button>
            </div>
          </form>
        </div>

		<div th:each="review : ${reviewList}" id="reviewed" class="border-bottom p-3 mb-3">
			<div id="stars" class="me-2" th:with="rating=${review.rating}">
			  <th:block th:each="num : ${#numbers.sequence(1, 5)}"><i th:if="${num <= rating}" class="fa-solid fa-star"></i><i th:if="${num > rating && (num - 0.5) <= rating}" class="fa-solid fa-star-half-stroke"></i><i th:if="${(num - 0.5) > rating}" class="fa-regular fa-star"></i></th:block>
			</div>

          <dl>
            <dd id="rating" th:text="${review.rating}" class="fw-bold pe-2"></dd>
          </dl>
          <p th:text="${review.content}" style="white-space: pre-wrap;">
            내용
          </p>
          <dl class="d-flex justify-content-between">
            <div>
              <dt id="reviewsUser" class="pe-2" th:text="${review.user.username}"></dt>
              <dd id="creDate" class="d-flex align-items-center"><i class="fa-solid fa-ellipsis pe-2"></i><div th:text="${#temporals.format(review.creDate, 'yyyy.MM.dd')}"></div></dd>
            </div>
            <!-- ✅ 본인만 수정/삭제 -->
            <div sec:authorize="isAuthenticated()" th:if="${#authentication.name == review.user.userId}">
              <form th:action="@{/doomchit/delete/{rno}(rno=${review.rno})}" method="post" style="display:inline;"
                onsubmit="return confirm('삭제할까?');">
                <button class="btn btn-sm btn-outline-danger">삭제</button>
              </form>
            </div>
          </dl>
        </div>

        <!-- 리뷰 없을 때 -->
        <div th:if="${#lists.isEmpty(reviewList)}" class="text-muted p-3">
          아직 리뷰가 없습니다.
        </div>

      </div>

    </div>

    <script>
      const rating_value = document.querySelector("#rating_value");
      const rating_input = document.querySelector("#rating_input");
      if (rating_value && rating_input) {
        rating_value.textContent = rating_input.value;
        rating_input.addEventListener("input", (event) => {
          rating_value.textContent = event.target.value;
        });
      }
    </script>
    <script th:src="@{/js/main.js}"></script>
</body>

</html>