<!DOCTYPE html>
<html
  lang="ko"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
	
	<title th:text="${music.title} + ' - DoomChit'">곡 정보 - DoomChit</title>

	<!-- Font -->
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Gafata&family=Inter:wght@400;500;700&display=swap"
	  rel="stylesheet">

	<!-- FontAwesome -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

    <!-- CSS -->

    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}" />
    <link rel="stylesheet" th:href="@{/css/fontawesome-all.min.css}" />
    <link rel="stylesheet" th:href="@{/css/reviews.css}" />
    <link rel="stylesheet" th:href="@{/css/common.css}" />
    
  </head>

  <body>
    <!-- 헤더 -->
    <th:block th:replace="~{fragments/header :: header}"></th:block>

    <div id="contents" class="container-xl" style="padding-top: 40px">
      <div id="music-info" class="border-top pb-5">
        <div id="music-summary" class="row featurette pb-4">
          <div
            id="album-main-img"
            class="featurette-image img-fluid col col-md-3 pb-3"
          >
            <img
              name="musicsImage"
              class="w-100"
              th:src="${music.image}"
              src="../img/album_sample.jpg"
            />
          </div>
          <div class="col pt-2 pe-3">
            <h3
              name="musicsTitle"
              class="text-break"
              th:text="${music.title}"
            ></h3>
            <h4 name="artist" class="text-break pb-2">
              <a href="#" th:text="${music.artist}"></a>
            </h4>
            <dl id="music-sum-list" class="list">
              <dt>발매일</dt>
              <dd name="relDate" th:text="${music.relDate}"></dd>
              <dt>장르</dt>
              <dd name="genre" th:text="${music.genre}"></dd>
            </dl>
            <div id="ratings">
              <div id="rating" class="fs-4">
				<dl class="d-flex align-items-center mb-0">
				  <dt
				    id="stars"
				    class="d-flex align-items-center me-2 review-stars"
				    th:with="rating=${avgRating}"
				  >
                    <!-- 평점 아이콘 -->
					<th:block th:each="num : ${#numbers.sequence(1, 5)}">
						<i th:if="${num <= rating}" class="fa-solid fa-star"></i><i th:if="${num > rating && (num - 0.5) <= rating}" class="fa-solid fa-star-half-stroke"></i><i th:if="${(num - 0.5) > rating}" class="fa-regular fa-star"></i>
				  	</th:block>
                    <label id="avgRating" th:text="${avgRating}" class="ms-1"></label>
                  </dt>

				  <dd
				      id="ratingCount"
				      class="ms-2 fs-6 text-muted"
				      th:text="|(${#lists.size(reviewList)}명이 참여)|"
				    ></dd>
				  </dl>
              </div>
            </div>
            <div id="likes">
              <dl>
                <dt>
                  <div>
                    <!-- 좋아요 버튼 (토글) -->
                    <a
                      th:href="@{/doomchit/like/toggle/{mno}(mno=${music.mno})}"
                      class="text-decoration-none"
                      sec:authorize="isAuthenticated()"
                    >
                      <i
                        id="likes-icon"
                        type="button"
                        th:class="${isLiked} ? 'fa-solid fa-heart fs-3 pe-1' : 'fa-regular fa-heart fs-3 pe-1'"
                        th:style="${isLiked} ? 'color: #a352d2;' : 'color: #000;'"
                      ></i>
                    </a>
                    <!-- 비로그인 시 로그인 페이지로 안내 -->
                    <a
                      th:href="@{/doomchit/login}"
                      class="text-decoration-none"
                      sec:authorize="isAnonymous()"
                      onclick="return confirm('로그인이 필요한 서비스입니다. 로그인 페이지로 이동하시겠습니까?');"
                    >
                      <i
                        id="likes-icon"
                        type="button"
                        class="fa-regular fa-heart fs-3 pe-1"
                        style="color: #000"
                      ></i>
                    </a>
                  </div>
                </dt>
                <dd
                  name="likesCount"
                  th:text="${#numbers.formatInteger(likeCount, 0, 'COMMA')}"
                >
                  0
                </dd>
              </dl>
            </div>
          </div>
        </div>

        <div id="music-lyrics" class="pb-4">
          <h2 class="pb-2 border-bottom">가사</h2>
          <div id="lyrics" name="lyrics">
            <div id="lyricsContent" class="lyrics-content collapsed">
              <p
                th:text="${music.lyrics != null ? music.lyrics : '가사 데이터가 없습니다.'}"
                style="white-space: pre-wrap"
              >
                가사 데이터가 없습니다.
              </p>
            </div>
            <button
              id="lyricsBtn"
              class="show-more-btn"
              onclick="toggleLyrics()"
            >
              펼치기<i class="fa-solid fa-angle-down ps-1"></i>
            </button>
          </div>
        </div>

        <div id="music-production" class="pb-4">
          <h2 class="pb-2 border-bottom">노래 / 작곡 / 작사</h2>
          <dl class="list">
            <dt class="flex-shrink-0 text-nowrap me-3">노래</dt>
            <dd
              name="artist"
              class="d-flex text-break"
              th:text="${music.artist}"
            >
              가수명
            </dd>
            <dt class="flex-shrink-0 text-nowrap me-3">작곡</dt>
            <dd
              name="composer"
              class="d-flex text-break"
              th:text="${music.composer}"
            >
              작곡가
            </dd>
            <dt class="flex-shrink-0 text-nowrap me-3">작사</dt>
            <dd
              name="lyricist"
              class="d-flex text-break"
              th:text="${music.lyricist}"
            >
              작사자
            </dd>
          </dl>
        </div>

        <div id="music-infos" class="pb-5">
          <h2 class="pb-2 border-bottom">상세 정보</h2>
          <dl class="list">
            <dt class="flex-shrink-0 text-nowrap me-3">제목</dt>
            <dd
              name="musicsTitle"
              class="d-flex text-break"
              th:text="${music.title}"
            >
              곡 제목
            </dd>
            <dt class="flex-shrink-0 text-nowrap me-3">장르</dt>
            <dd name="genre" class="d-flex text-break" th:text="${music.genre}">
              블루스
            </dd>
            <dt class="flex-shrink-0 text-nowrap me-3">발매일</dt>
            <dd
              name="relDate"
              class="d-flex text-break"
              th:text="${music.relDate}"
            >
              2026.01.07.
            </dd>

            <dt class="flex-shrink-0 text-nowrap me-3">발매사</dt>
            <dd
              name="publisher"
              class="d-flex text-break"
              th:text="${music.publisher}"
            >
              발매사
            </dd>
            <dt class="flex-shrink-0 text-nowrap me-3">기획사</dt>
            <dd
              name="agency"
              class="d-flex text-break"
              th:text="${music.agency}"
            >
              기획사
            </dd>
          </dl>
        </div>

        <div id="reviews" class="mb-5">
          <div id="reviews-tab">
            <div class="d-flex justify-content-between pb-2 mb-3 border-bottom">
              <h2>
                리뷰
                <span th:text="|(총 ${#lists.size(reviewList)}개)|" class="fs-4"></span>
              </h2>

              <div class="fs-6 pt-2">
                <th:block
                  th:with="isLatest=${param.sort == null or param.sort[0] == 'latest'}"
                >
                  <b th:if="${isLatest}" class="fw-bold">최신순</b>

                  <a
                    th:unless="${isLatest}"
                    th:href="@{/doomchit/reviews/{mno}(mno=${music.mno}, sort='latest')}"
                  >
                    최신순
                  </a>
                </th:block>
                |
                <th:block
                  th:with="isRating=${param.sort != null and param.sort[0] == 'rating'}"
                >
                  <b th:if="${isRating}" class="fw-bold">추천순</b>

                  <a
                    th:unless="${isRating}"
                    th:href="@{/doomchit/reviews/{mno}(mno=${music.mno}, sort='rating')}"
                  >
                    추천순
                  </a>
                </th:block>
              </div>
            </div>
          </div>

          <div
            sec:authorize="isAnonymous()"
            class="bg-body-secondary rounded mb-4"
          >
            <div class="p-3">
              댓글을 입력하려면 <a th:href="@{/doomchit/login}">로그인</a>을
              해야합니다.
            </div>
          </div>

          <div
            sec:authorize="isAuthenticated()"
            class="border rounded p-3 mb-4"
          >
            <form
              id="reviews"
              th:action="@{/doomchit/{mno}(mno=${music.mno})}"
              th:object="${reviewForm}"
              method="post"
            >
              <textarea
                th:field="*{content}"
                class="form-control border mb-3"
                placeholder="리뷰를 작성해 보세요."
                required
              ></textarea>
			  <div id="rating" class="d-flex justify-content-between align-items-center">
			    <div id="stars" class="me-2">
			      <div class="rating-wrap">
			        <!-- 배경(회색) 별 5개 -->
					<div class="stars" id="ratingStars" aria-label="평점 선택">
					  <!-- 배경 별 -->
					  <div class="stars-bg">
					    <i class="fa-regular fa-star"></i>
					    <i class="fa-regular fa-star"></i>
					    <i class="fa-regular fa-star"></i>
					    <i class="fa-regular fa-star"></i>
					    <i class="fa-regular fa-star"></i>
					  </div>

					  <!-- 채워지는 별 -->
					  <div class="stars-fill" id="starsFill">
					    <i class="fa-solid fa-star"></i>
					    <i class="fa-solid fa-star"></i>
					    <i class="fa-solid fa-star"></i>
					    <i class="fa-solid fa-star"></i>
					    <i class="fa-solid fa-star"></i>
					  </div>
					</div>
					
					<span class="rating-value ms-2">5.0</span>

			        <!-- 서버로 넘어갈 값 (중요: th:field 유지) -->
			        <input type="hidden" id="ratingInput" th:field="*{rating}" value="5.0" />
			        <!-- (선택) 숫자 보여주고 싶으면 -->
			        <!-- <span id="ratingText" class="ms-2"></span> -->
			      </div>
			    </div>

			    <button class="btn btn-primary btn-lg" type="submit">
			      리뷰 작성하기
			    </button>
			  </div>
            </form>
          </div>

		  <div
		    th:each="review : ${reviewList}"
		    class="border-bottom p-3 mb-3 review-item"
		    th:data-rno="${review.rno}"
		  >
		  
		  <div class="d-flex align-items-center review-stars" th:with="rating=${review.rating}">
		    <th:block th:each="num : ${#numbers.sequence(1, 5)}">
		      <i th:if="${num <= rating}" class="fa-solid fa-star"></i>
		      <i th:if="${num > rating && (num - 0.5) <= rating}" class="fa-solid fa-star-half-stroke"></i>
		      <i th:if="${(num - 0.5) > rating}" class="fa-regular fa-star"></i>
		    </th:block>

		    <span
		      class="review-rating-text"
		      th:text="${review.rating}"
		    >0.0</span>
		  </div>
			
            <p th:text="${review.content}" style="white-space: pre-wrap"></p>

            <dl>
              <div class="d-flex justify-content-between">
                <div>
                  <dt class="pe-2" th:text="${review.user.username}"></dt>
                  <dd class="d-flex align-items-center">
                    <i class="fa-solid fa-ellipsis pe-2"></i>
                    <div
                      th:text="${#temporals.format(review.creDate, 'yyyy.MM.dd')}"
                    ></div>
                  </dd>
                </div>

                <div
                  class="d-flex justify-content-end"
                  sec:authorize="isAuthenticated()"
                  th:if="${#authentication.name == review.user.userId}"
                >
                  <button
                    type="button"
                    class="btn btn-outline-secondary btn-sm m-1"
                    data-bs-toggle="modal"
                    th:data-bs-target="'#modifyModal' + ${review.rno}"
                  >
                    수정
                  </button>

                  <button
                    type="button"
                    class="btn btn-outline-danger btn-sm m-1"
                    data-bs-toggle="modal"
                    th:data-bs-target="'#deleteModal' + ${review.rno}"
                  >
                    삭제
                  </button>

                  <div
                    th:id="'modifyModal' + ${review.rno}"
                    class="modal fade"
                    data-bs-backdrop="static"
                    tabindex="-1"
                    aria-hidden="true"
                  >
                    <div class="modal-dialog modal-lg">
                      <div class="modal-content">
                        <div class="p-3">
                          <h5 class="modal-title pb-3">리뷰 수정하기</h5>
                          <form
                            th:action="@{/doomchit/modify/{rno}(rno=${review.rno})}"
							th:id="'modifyModal' + ${review.rno}"
							th:object="${reviewForm}"
                            method="post"
                          >
                            <textarea
                              name="content"
                              class="form-control border mb-3"
                              th:text="${review.content}"
                              required
                            ></textarea>

                            <div
                              class="d-flex justify-content-between align-items-center"
                            >
                              <div class="d-flex align-items-center">
								<!-- ⭐ 별점 선택 (수정 모달용) -->
								<div class="rating-wrap">
								  <div class="stars" aria-label="평점 선택">
								    <!-- 배경 별 -->
								    <div class="stars-bg">
								      <i class="fa-regular fa-star"></i>
								      <i class="fa-regular fa-star"></i>
								      <i class="fa-regular fa-star"></i>
								      <i class="fa-regular fa-star"></i>
								      <i class="fa-regular fa-star"></i>
								    </div>

								    <!-- 채워지는 별 -->
								    <div
								      class="stars-fill"
								      style="width: calc(([[${review.rating}]]) / 5 * 100%)"
								    >
								      <i class="fa-solid fa-star"></i>
								      <i class="fa-solid fa-star"></i>
								      <i class="fa-solid fa-star"></i>
								      <i class="fa-solid fa-star"></i>
								      <i class="fa-solid fa-star"></i>
								    </div>
								  </div>

								  <span class="rating-value ms-2" th:text="${review.rating}">4.5</span>
								  
								  <!-- 서버로 보낼 값 (⭐ 중요) -->
								  <input
								    type="hidden"
								    th:field="*{rating}"
								    th:value="${review.rating}"
								  />
								</div>
                              </div>
                              <div>
                                <button class="btn btn-primary" type="submit">
                                  수정
                                </button>
                                <button
                                  class="btn btn-secondary"
                                  type="button"
                                  data-bs-dismiss="modal"
                                >
                                  취소
                                </button>
                              </div>
                            </div>
                          </form>
						  
                        </div>
                      </div>
                    </div>
                  </div>

                  <div
                    th:id="'deleteModal' + ${review.rno}"
                    class="modal fade"
                    tabindex="-1"
                    aria-hidden="true"
                  >
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="p-3">
                          <div class="modal-header">
                            <h5 class="modal-title">리뷰 삭제하기</h5>
                            <button
                              type="button"
                              class="btn-close"
                              data-bs-dismiss="modal"
                              aria-label="Close"
                            ></button>
                          </div>

                          <p class="p-3">정말로 삭제하겠습니까?</p>
                          <form
						  class="d-flex justify-content-end"
						  th:action="@{/doomchit/delete/{rno}(rno=${review.rno})}"
                            method="post"
                          >
                            <div>
                              <button class="btn btn-primary" type="submit">
                                삭제
                              </button>
                              <button
                                class="btn btn-secondary"
                                type="button"
                                data-bs-dismiss="modal"
                              >
                                취소
                              </button>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </dl>
          </div>

          <!-- 리뷰 없을 때-->
          <div
            th:if="${#lists.size(reviewList) == 0 
		      and (myReview == null or #authentication.name != myReview.user.userId)}"
            class="text-muted p-3"
          >
            아직 등록된 리뷰가 없습니다.
          </div>

          <script th:src="@{/js/reviews.js}"></script>
          <script th:src="@{/js/main.js}"></script>
		  <script th:src="@{/js/bootstrap.min.js}"></script>
		  <script th:src="@{/js/fontawesome-all.min.js}"></script>
        </div>
      </div>
    </div>
  </body>
</html>
